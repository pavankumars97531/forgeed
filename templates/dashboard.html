<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ForgeEd</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-logo">
                <h2>ForgeEd</h2>
                <p>AI-Enhanced LMS</p>
            </div>
            
            <div class="sidebar-nav">
                <a href="/dashboard" class="nav-item active">
                    Dashboard
                </a>
                <a href="/courses" class="nav-item">
                    My Courses
                </a>
                <a href="/career-learning" class="nav-item">
                    Career Learning
                </a>
                <a href="/quiz" class="nav-item">
                    Quizzes
                </a>
                <a href="/wellbeing" class="nav-item">
                    Wellbeing
                </a>
                <a href="/analytics" class="nav-item">
                    Student Analytics
                </a>
                <a href="/slu-gpt" class="nav-item">
                    SLU GPT
                </a>
                <a href="/profile" class="nav-item">
                    Profile
                </a>
            </div>
            
            <div class="sidebar-footer">
                <a href="/logout" class="logout-btn">
                    Logout
                </a>
            </div>
        </nav>
        
        <main class="main-content">
            <div class="welcome-banner">
                <h2>Welcome back, {{ student['first_name'] }}! ðŸ‘‹</h2>
                <p>Here's what's happening with your studies today</p>
            </div>
            
            <!-- Personalized Quiz Quick Link -->
            <div class="quiz-quick-link">
                <div class="quiz-link-content">
                    <div class="quiz-icon">ðŸ’¡</div>
                    <div class="quiz-text">
                        <h3>Your Personalized Quiz for Today <span class="new-badge">NEW</span></h3>
                        <p>10 AI-generated questions based on your courses â€¢ Test your knowledge!</p>
                    </div>
                </div>
                <a href="/quiz" class="start-quiz-link">Start Quiz â†’</a>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-icon">ðŸ“š</div>
                    <div class="stat-value">{{ enrolled_count }}</div>
                    <div class="stat-label">Enrolled Courses</div>
                    <span class="stat-badge">Active</span>
                </div>
                
                <div class="stat-card green">
                    <div class="stat-icon">ðŸ“Š</div>
                    <div class="stat-value">{{ "%.2f"|format(student['gpa']) }}</div>
                    <div class="stat-label">Current GPA</div>
                </div>
                
                <div class="stat-card purple">
                    <div class="stat-icon">âœ“</div>
                    <div class="stat-value">{{ career_ready_percentage }}%</div>
                    <div class="stat-label">Career Ready</div>
                </div>
                
                <div class="stat-card orange">
                    <div class="stat-icon">ðŸ”¥</div>
                    <div class="stat-value">{{ wellbeing_score }}</div>
                    <div class="stat-label">Wellbeing Score</div>
                </div>
            </div>
            
            <!-- AI-Powered Insights -->
            <div class="insights-section">
                <h3>ðŸ¤– AI-Powered Insights</h3>
                
                {% for insight in insights %}
                <div class="insight-card {{ insight.type }}">
                    {{ insight.text }}
                </div>
                {% endfor %}
            </div>

            <!-- Combined Performance Graph -->
            <div class="graphs-section">
                <h3>ðŸ“ˆ Your Performance Trends</h3>
                <div class="combined-graph-card">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Fetch and render combined graph
        fetch('/api/dashboard-graph-data')
            .then(res => res.json())
            .then(data => {
                // Combine all dates
                const allDates = new Set();
                data.career_quiz.forEach(d => allDates.add(d.date));
                data.academic_quiz.forEach(d => allDates.add(d.date));
                data.wellbeing.forEach(d => allDates.add(d.date));
                
                const dates = Array.from(allDates).sort().slice(-7); // Last 7 days
                
                // Map scores to dates
                const careerScoreMap = {};
                data.career_quiz.forEach(d => {
                    careerScoreMap[d.date] = (d.score / d.total) * 100;
                });
                
                const academicScoreMap = {};
                data.academic_quiz.forEach(d => {
                    academicScoreMap[d.date] = (d.score / d.total) * 100;
                });
                
                const wellbeingScoreMap = {};
                data.wellbeing.forEach(d => {
                    wellbeingScoreMap[d.date] = d.score;
                });
                
                const careerScores = dates.map(d => careerScoreMap[d] || null);
                const academicScores = dates.map(d => academicScoreMap[d] || null);
                const wellbeingScores = dates.map(d => wellbeingScoreMap[d] || null);
                
                // Calculate max value for Y-axis
                const allScores = [...careerScores, ...academicScores, ...wellbeingScores].filter(s => s !== null);
                const maxScore = allScores.length > 0 ? Math.max(...allScores) : 100;
                const yAxisMax = Math.max(100, Math.ceil(maxScore / 10) * 10);
                
                new Chart(document.getElementById('performanceChart'), {
                    type: 'line',
                    data: {
                        labels: dates.length > 0 ? dates : ['No data yet'],
                        datasets: [
                            {
                                label: 'Career Quiz (%)',
                                data: careerScores.length > 0 ? careerScores : [0],
                                borderColor: '#9b7fd7',
                                backgroundColor: 'rgba(155, 127, 215, 0.1)',
                                tension: 0.4,
                                fill: false,
                                spanGaps: true
                            },
                            {
                                label: 'Academic Quiz (%)',
                                data: academicScores.length > 0 ? academicScores : [0],
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4,
                                fill: false,
                                spanGaps: true
                            },
                            {
                                label: 'Wellbeing Score',
                                data: wellbeingScores.length > 0 ? wellbeingScores : [0],
                                borderColor: '#f4a261',
                                backgroundColor: 'rgba(244, 162, 97, 0.1)',
                                tension: 0.4,
                                fill: false,
                                spanGaps: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yAxisMax,
                                title: {
                                    display: true,
                                    text: 'Score'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => console.error('Error loading graph data:', err));
    </script>
</body>
</html>
